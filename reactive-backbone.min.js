/*!
 * https://github.com/jhudson8/reactive-backbone v0.6.0;  MIT license; Joe Hudson<joehud_AT_gmail.com>
 */
!function(e){"function"==typeof define&&define.amd?define(["react","backbone","underscore"],e):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=function(t,n){e(t,n,require("underscore"))}:e(React,Backbone,_)}(function(e,t,n){!function(){var e=t.sync;t.async=n.extend({},t.Events),t.sync=function(i,o,r){function a(e){var t=r[e];r[e]=function(){var n=arguments;t&&t.apply(this,n);var i=s.indexOf(d);i>=0&&s.splice(i,1);var a="success"===e?[e,o,r]:[e,o,n[1],n[2],r];d.trigger.apply(d,a),a.splice(0,0,"complete"),d.trigger.apply(d,a),0===s.length&&o.trigger("async:load-complete")}}r=r||{},r.url||(r.url=n.result(o,"url"));var s=o._pendingAsyncEvents=o._pendingAsyncEvents||[],l=r&&r.event||i,d=n.extend({},t.Events);s.push(d),d.method=i,d.options=r,d.model=o,o.trigger("async",l,d,r),o.trigger("async:"+l,d,r),n.each([t.async,t.asyncHandler],function(e){e&&(e.trigger("async",l,o,d,r),e.trigger("async:"+l,o,d,r))}),a("success"),a("error");var c=r.intercept;if(c){if("function"==typeof c)return c(r);throw"intercept must be function(options)"}e.call(this,i,o,r)},n.each([t.Model,t.Collection],function(e){e.prototype.isLoading=function(){return this._pendingAsyncEvents&&this._pendingAsyncEvents.length>0?this._pendingAsyncEvents:!1}}),t.async.on("async:read",function(e,t){t.on("success",function(){e.hasBeenFetched=!0,e.hadFetchError=!1}),t.on("error",function(){e.hadFetchError=!0})})}(),function(){function t(n,i,o){function r(n){if(!i[n]){var r=e.mixins._mixins[n],a=!1;if(!r)throw new Error('invalid mixin "'+n+'"');"function"==typeof r&&(r=r(),a=!0),t(e.mixins._dependsOn[n],i,o),t(e.mixins._dependsInjected[n],i,o),i[n]=!0,a?t([r],i,o):o.push(r)}}function a(e){e&&(Array.isArray(e)?t(e,i,o):"string"==typeof e?r(e):o.push(e))}if(Array.isArray(n))for(var s=0;s<n.length;s++)a(n[s]);else a(n)}function n(t,n,i,o){var r=e.mixins;(o||!r._mixins[t])&&(r._dependsOn[t]=i.length&&i,r._mixins[t]=n)}function i(){}function o(e,t){return Array.isArray(e[1])?[e[0],e[1][0],Array.prototype.slice.call(e[1],1),t]:[e[0],e[1],Array.prototype.slice.call(e,2),t]}var r=e.createClass;e.createClass=function(t){return t.mixins&&(t.mixins=e.mixins.get(t.mixins)),r.apply(e,arguments)},e.mixins={get:function(){var e=[],n={};return t(Array.prototype.slice.call(arguments),n,e),e},inject:function(e){var t=this._dependsInjected[e];t||(t=this._dependsInjected[e]=[]),t.push(Array.prototype.slice.call(arguments,1))},alias:function(e){n(e,i,Array.prototype.slice.call(arguments,1),!1)},add:function(){n.apply(this,o(arguments,!1))},replace:function(){n.apply(this,o(arguments,!0))},exists:function(e){return this._mixins[e]||!1},_dependsOn:{},_dependsInjected:{},_mixins:{}},e.mixins.add("deferUpdate",{getInitialState:function(){return{}},deferUpdate:function(){var e=this.state;if(!e._deferUpdate){e._deferUpdate=!0;var t=this;setTimeout(function(){delete e._deferUpdate,t.isMounted()&&t.forceUpdate()},0)}}})}(),function(){function t(s,l,d,c){if(!c){var f,u=l;if("object"==typeof l&&(u=l.callback.call(this)),"string"==typeof l&&(f=a.indexOf(l)>=0,u=d[l]),!u)throw'no callback function exists for "'+l+'"';l=function(){return u.apply(d,f?[]:arguments)}}var h=s.match(r);if(h){var m=h[1],v=h[2].split(/\s*,\s*/),p=h[3],g=e.events.specials[m];if(g)return 1===v.length&&""===v[0]&&(v=[]),l=g.call(d,l,v),t(p,l,d,!0);throw new Error('invalid special event handler "'+m+"'")}var y=s.match(o),x=y[1];path=y[2],handler=n[x];for(var _=0;!handler&&_<i.length;_++)x.match(i[_].pattern)&&(handler=i[_].handler);if(!handler)throw'no handler registered for "'+s+'"';return handler.call(d,{key:x,path:path},l)}var n={},i=[],o=/^([^:]+):?(.*)/,r=/^\*([^\(]+)\(([^)]*)\):(.*)/,a=["forceUpdate"],s={standard:function(e){var t={on:e.onKey||"on",off:e.offKey||"off"},n=e.target;return function(i,o){function r(e,i){return function(){var r="function"==typeof n?n.call(i,a):n;r&&r[t[e]](a,o)}}var a=i.path;return{on:r("on",this),off:r("off",this),initialize:e.initialize}}}},l=e.events={specials:{},handle:function(e,t){"function"!=typeof t&&(t=s[t.type||"standard"](t)),e instanceof RegExp?i.push({pattern:e,handler:t}):n[e]=t}};"undefined"!=typeof window&&l.handle("window",{target:window,onKey:"addEventListener",offKey:"removeEventListener"}),l.handle("ref",function(e,t){var n=e.path.match(o),i=n[1],r=n[2];return{on:function(){var e=this.refs[i];e&&e.on(r,t)},off:function(){var e=this.refs[i];e&&e.off(r,t)}}}),l.handle("dom",function(e,t){var n=e.path.match(o);return{on:function(){$(this.getDOMNode()).on(n[1],n[2],t)},off:function(){$(this.getDOMNode()).off(n[1],n[2],t)}}}),l.handle("repeat",function(e,t){var n,i=parseInt(e.path,10);return{on:function(){n=setInterval(t,i)},off:function(){n=!!clearInterval(n)}}}),l.handle("!repeat",function(e,t){function n(e){e!==!0&&t(),setTimeout(function(){i&&requestAnimationFrame(n)},o)}var i,o=parseInt(e.path,10);return{on:function(){i=!0,n(!0)},off:function(){i=!1}}}),e.mixins.add("events",function(){function e(e,t){return function(){e.apply(t,arguments)}}var n=[{getInitialState:function(){var e=this._eventHandlers=[];if(this.events){var n;for(var i in this.events)n=t(i,this.events[i],this),n.initialize&&n.initialize.call(this),e.push(n)}return null},componentDidMount:function(){for(var e=this._eventHandlers,t=0;t<e.length;t++)e[t].on.call(this)},componentWillUnmount:function(){for(var e=this._eventHandlers,t=0;t<e.length;t++)e[t].off.call(this)}}];if(l.mixin){var i={},o={};for(var r in l.mixin)i[r]=e(l.mixin[r],o);i.getInitialState=function(){return{__events:o}},n.push(i)}return n}),e.mixins.add("triggerWith",{triggerWith:function(){var e=Array.prototype.slice.call(arguments),t=this;return function(){t.trigger.apply(this,e)}}})}(),function(){function i(e){return e?n.isArray(e)?e:[e]:void 0}function o(e){return e.props.key||e.props.ref}function r(e,t,o,r){var a,s,l=i(t.props[e]);if(l){for(var d=0;d<l.length;d++)a=l[d],s=o.replace("{key}",a),t.modelOn(s,n.bind(r,t),this);return l}}function a(e,t){var i,o=this;if(t=n.extend({type:e},t),this.state?(i=this.state.__modelEvents,o=this.state):i=this.__modelEvents,i||(i=o.__modelEvents=[]),t.context=t.context||this,i.push(t),this.isMounted()){var r=t.model||this.getModel();r&&r[t.type](t.event,t.callback,t.context)}}function s(e){for(var t,n=0;n<e.length;n++)t=e[n],"true"===t?t=!0:"false"===t?t=!1:t.match(/^[0-9]+$/)?t=parseInt(t):t.match(/^[0-9]+\.[0-9]+/)&&(t=parseFloat(t)),e[n]=t;return e}if(e.mixins.add("modelAware",{getModel:function(){return this.props.model},setModel:function(e){this._modelUnbindAll&&this._modelUnbindAll(!0),this.setProps({model:e}),this._modelBindAll&&this.isMounted()&&this._modelBindAll()}}),e.mixins.add("modelValueAware",{getModelValue:function(){var e=o(this),t=this.getModel();return t&&e?t.get(e):void 0},setModelValue:function(e,t){var n=o(this),i=this.getModel();return i&&n?i.set(n,e,t):void 0}},"modelAware"),e.mixins.add("modelPopulate",{modelPopulate:function(e,t,i){n.isFunction(e)&&(i=t,t=e,e=void 0);var r={};if(e||(e=n.map(this.refs,function(e){return e})),n.each(e,function(e){if(e.getModelValue){var t=o(e),n=e.getModelValue();r[t]=n}}),t&&this.getModel){var a=this.getModel();a&&a.set(r,i||{validate:!0})&&t(a)}return r}}),e.mixins.add("modelValidator",{modelValidate:function(e,t){var n=this.getModel();return n&&n.validate?this.modelIndexErrors(n.validate(e,t))||!1:void 0}},"modelAware","modelIndexErrors"),e.mixins.add("modelEventAware",{getInitialState:function(){return{}},modelOn:function(e,t){var n=t?{event:e,callback:t}:e;a.call(this,"on",n)},modelOnce:function(e,t){var n=t?{event:e,callback:t}:e;a.call(this,"once",n)},modelOff:function(e,t){var n=t?{event:e,callback:t}:e,i=this.state.__modelEvents;if(i)for(var o,r=0;r<i.length;r++)if(o=i[r],o.event===n.event&&o.model===n.model&&o.callback===n.callback){var a=n.model||this.getModel();a&&a.off(n.event,n.callback,n.context||this),i.splice(r,1)}},_modelBindAll:function(){var e=this.__modelEvents;if(e&&(delete this.__modelEvents,this.state.__modelEvents=e),e=this.state.__modelEvents){var t=this.getModel();n.each(e,function(e){var n=e.model||t;n&&n[e.type](e.event,e.callback,e.context)})}},_modelUnbindAll:function(e){var t=this.state.__modelEvents,i=this.getModel();t&&(n.each(t,function(e){var t=e.model||i;t&&t.off(e.event,e.callback,e.context)}),e||(this.state.__modelEvents=[]))},componentDidMount:function(){this._modelUnbindAll(!0),this._modelBindAll(!0)},componentWillUnmount:function(){this._modelUnbindAll(!0)}},"modelAware"),e.mixins.add("modelChangeAware",{getInitialState:function(){return n.each(["change","reset","add","remove","sort"],function(e){this.modelOn(e,function(){this.deferUpdate()})},this),null}},"modelEventAware","deferUpdate"),e.mixins.add("modelAsyncAware",{getInitialState:function(){this.modelOn("async",function(e,t){this.setState({loading:!0});var n=this.getModel();t.on("success",function(){this.isMounted()&&this.setState({loading:!!n.isLoading()})},this),t.on("error",function(e){this.isMounted()&&this.setState({loading:!!n.isLoading(),error:e})},this)});var e=this.getModel();return e&&e.isLoading()?{loading:!0}:{}},componentDidMount:function(){var e=this.state,t=this.getModel();t&&(t.isLoading()?(this.modelOnce("async:load-complete",function(){this.setState({loading:!1})}),e.loading||this.setState({loading:!0})):e.loading&&this.setState({loading:!1}))}},"modelEventAware"),e.mixins.add("modelInvalidAware",{getInitialState:function(){var e=o(this);return e&&this.modelOn("invalid",function(t,n){n=this.modelIndexErrors(n)||{};var i=n[e];i&&this.setState({error:i})}),{}}},"modelIndexErrors","modelEventAware"),e.mixins.add("modelIndexErrors",{modelIndexErrors:function(e){if(Array.isArray(e)){var t={};return n.each(e,function(e){for(var n in e)t[n]=e[n]}),t}return e}}),e.mixins.add("modelLoadOn",{getInitialState:function(){var e=r("loadOn",this,"async:{key}",function(e){this.setState({loading:!0}),e.on("complete",function(){this.isMounted()&&this.setState({loading:!1})},this)}),t=this.getModel();if(t){var n,i=t.isLoading();if(i)for(var o=function(){this.isMounted()&&this.setState({loading:!1})},a=0;a<i.length;a++){var s=e.indexOf(i[a].method);if(s>=0)return n=e[s],i[a].on("complete",o,this),{loading:!0}}}return{}}},"modelEventAware"),e.mixins.add("modelUpdateOn",{getInitialState:function(){r("updateOn",this,"{key}",function(){this.deferUpdate()})},updateOnModelEvent:function(){function e(){this.deferUpdate()}n.each(arguments,function(t){this.modelOn(t,e)},this)}},"modelEventAware","deferUpdate"),e.events){e.events.mixin=e.events.mixin||t.Events;var l=/^model(\[.+\])?$/;e.events.handle(l,function(e,t){var n=e.key.match(l),i=n[1]&&n[1].substring(1,n[1].length-1),o=i&&(this.props[i]||this.refs[i]);if(!o&&i)throw new Error('no model found with "'+i+'"');var r={model:o,event:e.path,callback:t};return{on:function(){this.modelOn(r)},off:function(){}}});var d=e.events.specials;if(d){var c=["memoize","delay","defer","throttle","debounce","once"];n.each(c,function(e){d[e]=d[e]||function(t,i){return i=s(i),i.splice(0,0,t),n[e].apply(n,i)}})}}}()});