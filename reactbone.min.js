/*!
 * https://github.com/jhudson8/reactbone v0.6.0;  MIT license; Joe Hudson<joehud_AT_gmail.com>
 */
!function(t){"function"==typeof define&&define.amd?define(["react","backbone","underscore"],t):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=function(e,n){t(e,n,require("underscore"))}:t(React,Backbone,_)}(function(t,e,n){!function(){var t=e.sync;e.async=n.extend({},e.Events),e.sync=function(i,o,r){function a(t){var e=r[t];r[t]=function(){var n=arguments;e&&e.apply(this,n);var i=s.indexOf(d);i>=0&&s.splice(i,1);var a="success"===t?[t,o,r]:[t,o,n[1],n[2],r];d.trigger.apply(d,a),a.splice(0,0,"complete"),d.trigger.apply(d,a),0===s.length&&o.trigger("async:load-complete")}}r=r||{},r.url||(r.url=n.result(o,"url"));var s=o._pendingAsyncEvents=o._pendingAsyncEvents||[],l=r&&r.event||i,d=n.extend({},e.Events);s.push(d),d.method=i,d.options=r,d.model=o,o.trigger("async",l,d,r),o.trigger("async:"+l,d,r),n.each([e.async,e.asyncHandler],function(t){t&&(t.trigger("async",l,o,d,r),t.trigger("async:"+l,o,d,r))}),a("success"),a("error");var c=r.intercept;if(c){if("function"==typeof c)return c(r);throw"intercept must be function(options)"}t.call(this,i,o,r)},n.each([e.Model,e.Collection],function(t){t.prototype.isLoading=function(){return this._pendingAsyncEvents&&this._pendingAsyncEvents.length>0?this._pendingAsyncEvents:!1}}),e.async.on("async:read",function(t,e){e.on("success",function(){t.hasBeenFetched=!0,t.hadFetchError=!1}),e.on("error",function(){t.hadFetchError=!0})})}(),function(){function e(n,i,o){function r(n){if(!i[n]){var r=t.mixins._mixins[n],a=!1;if(!r)throw new Error('invalid mixin "'+n+'"');"function"==typeof r&&(r=r(),a=!0),e(t.mixins._dependsOn[n],i,o),e(t.mixins._dependsInjected[n],i,o),i[n]=!0,a?e([r],i,o):o.push(r)}}function a(t){t&&(Array.isArray(t)?e(t,i,o):"string"==typeof t?r(t):o.push(t))}if(Array.isArray(n))for(var s=0;s<n.length;s++)a(n[s]);else a(n)}function n(e,n,i,o){var r=t.mixins;(o||!r._mixins[e])&&(r._dependsOn[e]=i.length&&i,r._mixins[e]=n)}function i(){}function o(t,e){return Array.isArray(t[1])?[t[0],t[1][0],Array.prototype.slice.call(t[1],1),e]:[t[0],t[1],Array.prototype.slice.call(t,2),e]}var r=t.createClass;t.createClass=function(e){return e.mixins&&(e.mixins=t.mixins.get(e.mixins)),r.apply(t,arguments)},t.mixins={get:function(){var t=[],n={};return e(Array.prototype.slice.call(arguments),n,t),t},inject:function(t){var e=this._dependsInjected[t];e||(e=this._dependsInjected[t]=[]),e.push(Array.prototype.slice.call(arguments,1))},alias:function(t){n(t,i,Array.prototype.slice.call(arguments,1),!1)},add:function(){n.apply(this,o(arguments,!1))},replace:function(){n.apply(this,o(arguments,!0))},exists:function(t){return this._mixins[t]||!1},_dependsOn:{},_dependsInjected:{},_mixins:{}},t.mixins.add("deferUpdate",{getInitialState:function(){return{}},deferUpdate:function(){var t=this.state;if(!t._deferUpdate){t._deferUpdate=!0;var e=this;setTimeout(function(){delete t._deferUpdate,e.isMounted()&&e.forceUpdate()},0)}}})}(),function(){function e(s,l,d,c){if(!c){var f,u=l;if("object"==typeof l&&(u=l.callback.call(this)),"string"==typeof l&&(f=a.indexOf(l)>=0,u=d[l]),!u)throw'no callback function exists for "'+l+'"';l=function(){return u.apply(d,f?[]:arguments)}}var h=s.match(r);if(h){var m=h[1],v=h[2].split(/\s*,\s*/),p=h[3],g=t.events.specials[m];if(g)return 1===v.length&&""===v[0]&&(v=[]),l=g.call(d,l,v),e(p,l,d,!0);throw new Error('invalid special event handler "'+m+"'")}var y=s.match(o),x=y[1];path=y[2],handler=n[x];for(var _=0;!handler&&_<i.length;_++)x.match(i[_].pattern)&&(handler=i[_].handler);if(!handler)throw'no handler registered for "'+s+'"';return handler.call(d,{key:x,path:path},l)}var n={},i=[],o=/^([^:]+):?(.*)/,r=/^\*([^\(]+)\(([^)]*)\):(.*)/,a=["forceUpdate"],s={standard:function(t){var e={on:t.onKey||"on",off:t.offKey||"off"},n=t.target;return function(i,o){function r(t,i){return function(){var r="function"==typeof n?n.call(i,a):n;r&&r[e[t]](a,o)}}var a=i.path;return{on:r("on",this),off:r("off",this),initialize:t.initialize}}}},l=t.events={specials:{},handle:function(t,e){"function"!=typeof e&&(e=s[e.type||"standard"](e)),t instanceof RegExp?i.push({pattern:t,handler:e}):n[t]=e}};"undefined"!=typeof window&&l.handle("window",{target:window,onKey:"addEventListener",offKey:"removeEventListener"}),l.handle("ref",function(t,e){var n=t.path.match(o),i=n[1],r=n[2];return{on:function(){var t=this.refs[i];t&&t.on(r,e)},off:function(){var t=this.refs[i];t&&t.off(r,e)}}}),l.handle("dom",function(t,e){var n=t.path.match(o);return{on:function(){$(this.getDOMNode()).on(n[1],n[2],e)},off:function(){$(this.getDOMNode()).off(n[1],n[2],e)}}}),l.handle("repeat",function(t,e){var n,i=parseInt(t.path,10);return{on:function(){n=setInterval(e,i)},off:function(){n=!!clearInterval(n)}}}),l.handle("!repeat",function(t,e){function n(t){t!==!0&&e(),setTimeout(function(){i&&requestAnimationFrame(n)},o)}var i,o=parseInt(t.path,10);return{on:function(){i=!0,n(!0)},off:function(){i=!1}}}),t.mixins.add("events",function(){function t(t,e){return function(){t.apply(e,arguments)}}var n=[{getInitialState:function(){var t=this._eventHandlers=[];if(this.events){var n;for(var i in this.events)n=e(i,this.events[i],this),n.initialize&&n.initialize.call(this),t.push(n)}return null},componentDidMount:function(){for(var t=this._eventHandlers,e=0;e<t.length;e++)t[e].on.call(this)},componentWillUnmount:function(){for(var t=this._eventHandlers,e=0;e<t.length;e++)t[e].off.call(this)}}];if(l.mixin){var i={},o={};for(var r in l.mixin)i[r]=t(l.mixin[r],o);i.getInitialState=function(){return{__events:o}},n.push(i)}return n}),t.mixins.add("triggerWith",{triggerWith:function(){var t=Array.prototype.slice.call(arguments),e=this;return function(){e.trigger.apply(this,t)}}})}(),function(){function i(t){return t?n.isArray(t)?t:[t]:void 0}function o(t){return t.props.key||t.props.ref}function r(t,e,o,r){var a,s,l=i(e.props[t]);if(l){for(var d=0;d<l.length;d++)a=l[d],s=o.replace("{key}",a),e.modelOn(s,n.bind(r,e),this);return l}}function a(t,e){var i,o=this;if(e=n.extend({type:t},e),this.state?(i=this.state.__modelEvents,o=this.state):i=this.__modelEvents,i||(i=o.__modelEvents=[]),e.context=e.context||this,i.push(e),this.isMounted()){var r=e.model||this.getModel();r&&r[e.type](e.event,e.callback,e.context)}}function s(t){for(var e,n=0;n<t.length;n++)e=t[n],"true"===e?e=!0:"false"===e?e=!1:e.match(/^[0-9]+$/)?e=parseInt(e):e.match(/^[0-9]+\.[0-9]+/)&&(e=parseFloat(e)),t[n]=e;return t}if(t.mixins.add("modelAware",{getModel:function(){return this.props.model},setModel:function(t){this._modelUnbindAll&&this._modelUnbindAll(!0),this.setProps({model:t}),this._modelBindAll&&this.isMounted()&&this._modelBindAll()}}),t.mixins.add("modelValueAware",{getModelValue:function(){var t=o(this),e=this.getModel();return e&&t?e.get(t):void 0},setModelValue:function(t,e){var n=o(this),i=this.getModel();return i&&n?i.set(n,t,e):void 0}},"modelAware"),t.mixins.add("modelPopulate",{modelPopulate:function(t,e,i){n.isFunction(t)&&(i=e,e=t,t=void 0);var r={};if(t||(t=n.map(this.refs,function(t){return t})),n.each(t,function(t){if(t.getUIValue){var e=o(t),n=t.getUIValue();r[e]=n}}),e&&this.getModel){var a=this.getModel();a&&a.set(r,i||{validate:!0})&&e.call(this,a)}return r}}),t.mixins.add("modelValidator",{modelValidate:function(t,e){var n=this.getModel();return n&&n.validate?this.modelIndexErrors(n.validate(t,e))||!1:void 0}},"modelAware","modelIndexErrors"),t.mixins.add("modelEventAware",{getInitialState:function(){return{}},modelOn:function(t,e){var n=e?{event:t,callback:e}:t;a.call(this,"on",n)},modelOnce:function(t,e){var n=e?{event:t,callback:e}:t;a.call(this,"once",n)},modelOff:function(t,e){var n=e?{event:t,callback:e}:t,i=this.state.__modelEvents;if(i)for(var o,r=0;r<i.length;r++)if(o=i[r],o.event===n.event&&o.model===n.model&&o.callback===n.callback){var a=n.model||this.getModel();a&&a.off(n.event,n.callback,n.context||this),i.splice(r,1)}},_modelBindAll:function(){if(this.state){var t=this.__modelEvents;if(t&&(delete this.__modelEvents,this.state.__modelEvents=t),t=this.state.__modelEvents){var e=this.getModel();n.each(t,function(t){var n=t.model||e;n&&n[t.type](t.event,t.callback,t.context)})}}},_modelUnbindAll:function(t){if(this.state){var e=this.state.__modelEvents,i=this.getModel();e&&(n.each(e,function(t){var e=t.model||i;e&&e.off(t.event,t.callback,t.context)}),t||(this.state.__modelEvents=[]))}},componentDidMount:function(){this._modelUnbindAll(!0),this._modelBindAll(!0)},componentWillUnmount:function(){this._modelUnbindAll(!0)}},"modelAware"),t.mixins.add("modelChangeAware",{getInitialState:function(){return n.each(["change","reset","add","remove","sort"],function(t){this.modelOn(t,function(){this.deferUpdate()})},this),null}},"modelEventAware","deferUpdate"),t.mixins.add("modelAsyncAware",{getInitialState:function(){this.modelOn("async",function(t,e){this.setState({loading:!0});var n=this.getModel();e.on("success",function(){this.isMounted()&&this.setState({loading:!!n.isLoading()})},this),e.on("error",function(t){this.isMounted()&&this.setState({loading:!!n.isLoading(),error:t})},this)});var t=this.getModel();return t&&t.isLoading()?{loading:!0}:{}},componentDidMount:function(){var t=this.state,e=this.getModel();e&&(e.isLoading()?(this.modelOnce("async:load-complete",function(){this.setState({loading:!1})}),t.loading||this.setState({loading:!0})):t.loading&&this.setState({loading:!1}))}},"modelEventAware"),t.mixins.add("modelInvalidAware",{getInitialState:function(){var t=o(this);return t&&this.modelOn("invalid",function(e,n){n=this.modelIndexErrors(n)||{};var i=n[t];i&&this.setState({error:i})}),{}}},"modelIndexErrors","modelEventAware"),t.mixins.add("modelIndexErrors",{modelIndexErrors:function(t){if(Array.isArray(t)){var e={};return n.each(t,function(t){for(var n in t)e[n]=t[n]}),e}return t}}),t.mixins.add("modelLoadOn",{getInitialState:function(){var t=r("loadOn",this,"async:{key}",function(t){this.setState({loading:!0}),t.on("complete",function(){this.isMounted()&&this.setState({loading:!1})},this)}),e=this.getModel();if(e){var n,i=e.isLoading();if(i)for(var o=function(){this.isMounted()&&this.setState({loading:!1})},a=0;a<i.length;a++){var s=t.indexOf(i[a].method);if(s>=0)return n=t[s],i[a].on("complete",o,this),{loading:!0}}}return{}}},"modelEventAware"),t.mixins.add("modelUpdateOn",{getInitialState:function(){r("updateOn",this,"{key}",function(){this.deferUpdate()})},updateOnModelEvent:function(){function t(){this.deferUpdate()}n.each(arguments,function(e){this.modelOn(e,t)},this)}},"modelEventAware","deferUpdate"),t.events){t.events.mixin=t.events.mixin||e.Events;var l=/^model(\[.+\])?$/;t.events.handle(l,function(t,e){var n=t.key.match(l),i=n[1]&&n[1].substring(1,n[1].length-1),o=i&&(this.props[i]||this.refs[i]);if(!o&&i)throw new Error('no model found with "'+i+'"');var r={model:o,event:t.path,callback:e};return{on:function(){this.modelOn(r)},off:function(){}}});var d=t.events.specials;if(d){var c=["memoize","delay","defer","throttle","debounce","once"];n.each(c,function(t){d[t]=d[t]||function(e,i){return i=s(i),i.splice(0,0,e),n[t].apply(n,i)}})}}}()});