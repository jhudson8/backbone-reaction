/*!
 * https://github.com/jhudson8/backbone-reaction v0.8.1;  MIT license; Joe Hudson<joehud_AT_gmail.com>
 */
!function(e){"function"==typeof define&&define.amd?define(["react","backbone","underscore"],e):"undefined"!=typeof exports&&"undefined"!=typeof require?module.exports=function(t,n){e(t,n,require("underscore"))}:e(React,Backbone,_)}(function(React,Backbone,_){!function(){var e=Backbone.sync;Backbone.async=_.extend({},Backbone.Events),Backbone.sync=function(t,n,i){function a(e){var t=i[e];i[e]=function(){var a=arguments;t&&t.apply(this,a);var o=r.indexOf(s);o>=0&&r.splice(o,1);var c="success"===e?[e,n,i]:[e,n,a[1],a[2],i];s.trigger.apply(s,c),c.splice(0,0,"complete"),s.trigger.apply(s,c),0===r.length&&n.trigger("async:load-complete")}}i=i||{},i.url||(i.url=_.result(n,"url"));var r=n._pendingAsyncEvents=n._pendingAsyncEvents||[],o=i&&i.event||t,s=_.extend({},Backbone.Events);r.push(s),s.method=t,s.options=i,s.model=n,n.trigger("async",o,s,i),n.trigger("async:"+o,s,i),_.each([Backbone.async,Backbone.asyncHandler],function(e){e&&(e.trigger("async",o,n,s,i),e.trigger("async:"+o,n,s,i))}),a("success"),a("error");var c=i.intercept;if(c){if("function"==typeof c)return c(i);throw"intercept must be function(options)"}e.call(this,t,n,i)},_.each([Backbone.Model,Backbone.Collection],function(e){e.prototype.isLoading=function(){return this._pendingAsyncEvents&&this._pendingAsyncEvents.length>0?this._pendingAsyncEvents:!1}}),Backbone.async.on("async:read",function(e,t){t.on("success",function(){e.hasBeenFetched=!0,e.hadFetchError=!1}),t.on("error",function(){e.hadFetchError=!0})})}(),function(){function get(values,index,initiatedOnce,rtn){function addTo(name){var indexName=name,match=name.match(/^([^\(]*)\s*\(([^\)]*)\)\s*/),params=match&&match[2];if(name=match&&match[1]||name,!index[indexName]){params&&(params=eval("["+params+"]"));var mixin=React.mixins._mixins[name],checkAgain=!1,skip=!1;if(!mixin)throw new Error('invalid mixin "'+name+'"');if("function"==typeof mixin)React.mixins._initiatedOnce[name]?(initiatedOnce[name]=initiatedOnce[name]||[],initiatedOnce[name].push(params),skip=!0):(mixin=mixin.apply(this,params||[]),checkAgain=!0);else if(params)throw new Error('the mixin "'+name+'" does not support parameters');get(React.mixins._dependsOn[name],index,initiatedOnce,rtn),get(React.mixins._dependsInjected[name],index,initiatedOnce,rtn),index[indexName]=!0,checkAgain?get([mixin],index,initiatedOnce,rtn):skip||rtn.push(mixin)}}function handleMixin(e){e&&(Array.isArray(e)?get(e,index,initiatedOnce,rtn):"string"==typeof e?addTo(e):rtn.push(e))}if(Array.isArray(values))for(var i=0;i<values.length;i++)handleMixin(values[i]);else handleMixin(values)}function getInitiatedOnce(e,t){function n(e,n){e=e.apply(this,n||[]),t.push(e)}for(var i in e)e.hasOwnProperty(i)&&n(React.mixins._mixins[i],e[i])}function addMixin(e,t,n,i,a){var r=React.mixins;(i||!r._mixins[e])&&(r._dependsOn[e]=n.length&&n,r._mixins[e]=t,a&&(r._initiatedOnce[e]=!0))}function GROUP(){}function mixinParams(e,t){var n,i=e[0],a=!1;if("object"==typeof i?(n=i.name,a=i.initiatedOnce):n=i,!n||!n.length)throw new Error("the mixin name hasn't been specified");return Array.isArray(e[1])?[n,e[1][0],Array.prototype.slice.call(e[1],1),t,a]:[n,e[1],Array.prototype.slice.call(e,2),t,a]}var _createClass=React.createClass;React.createClass=function(e){return e.mixins&&(e.mixins=React.mixins.get(e.mixins)),_createClass.apply(React,arguments)},React.mixins={get:function(){var e=[],t={},n={};return get(Array.prototype.slice.call(arguments),t,n,e),getInitiatedOnce(n,e),e},inject:function(e){var t=this._dependsInjected[e];t||(t=this._dependsInjected[e]=[]),t.push(Array.prototype.slice.call(arguments,1))},alias:function(e){addMixin(e,GROUP,Array.prototype.slice.call(arguments,1),!1)},add:function(){addMixin.apply(this,mixinParams(arguments,!1))},replace:function(){addMixin.apply(this,mixinParams(arguments,!0))},exists:function(e){return this._mixins[e]||!1},_dependsOn:{},_dependsInjected:{},_mixins:{},_initiatedOnce:{}},React.mixins.add("deferUpdate",{getInitialState:function(){return{}},deferUpdate:function(){var e=this.state;if(!e._deferUpdate){e._deferUpdate=!0;var t=this;setTimeout(function(){delete e._deferUpdate,t.isMounted()&&t.forceUpdate()},0)}}})}(),function(){function e(o,s,c,d){if(!d){var l,u=s;if("object"==typeof s&&(u=s.callback.call(this)),"string"==typeof s&&(l=r.indexOf(s)>=0,u=c[s]),!u)throw'no callback function exists for "'+s+'"';s=function(){return u.apply(c,l?[]:arguments)}}var f=o.match(a);if(f){var h=f[1],m=f[2].split(/\s*,\s*/),p=f[3],v=React.events.specials[h];if(v)return 1===m.length&&""===m[0]&&(m=[]),s=v.call(c,s,m),e(p,s,c,!0);throw new Error('invalid special event handler "'+h+"'")}var g=o.match(i),x=g[1];path=g[2],handler=t[x];for(var y=0;!handler&&y<n.length;y++)x.match(n[y].pattern)&&(handler=n[y].handler);if(!handler)throw'no handler registered for "'+o+'"';return handler.call(c,{key:x,path:path},s)}var t={},n=[],i=/^([^:]+):?(.*)/,a=/^\*([^\(]+)\(([^)]*)\):(.*)/,r=["forceUpdate"],o={standard:function(e){var t={on:e.onKey||"on",off:e.offKey||"off"},n=e.target;return function(i,a){function r(e,i){return function(){var r="function"==typeof n?n.call(i,o):n;r&&r[t[e]](o,a)}}var o=i.path;return{on:r("on",this),off:r("off",this),initialize:e.initialize}}}},s=React.events={specials:{},handle:function(e,i){"function"!=typeof i&&(i=o[i.type||"standard"](i)),e instanceof RegExp?n.push({pattern:e,handler:i}):t[e]=i}};"undefined"!=typeof window&&s.handle("window",{target:window,onKey:"addEventListener",offKey:"removeEventListener"}),s.handle("ref",function(e,t){var n,a,r=e.path.match(i),o=r[1],s=r[2];return{on:function(){var e=this.refs[o];e&&(a=e.state||e,e.on(s,t),n=e)},off:function(){n&&(n.off(s,t),n=void 0,a=void 0)},isStale:function(){if(!n)return!!this.refs[o];var e=this.refs[o];return e&&(e.state||e)===a?void 0:!0}}}),s.handle("dom",function(e,t){var n=e.path.match(i);return{on:function(){$(this.getDOMNode()).on(n[1],n[2],t)},off:function(){$(this.getDOMNode()).off(n[1],n[2],t)}}}),s.handle("repeat",function(e,t){var n,i=parseInt(e.path,10);return{on:function(){n=setInterval(t,i)},off:function(){n=!!clearInterval(n)}}}),s.handle("!repeat",function(e,t){function n(e){e!==!0&&t(),setTimeout(function(){i&&requestAnimationFrame(n)},a)}var i,a=parseInt(e.path,10);return{on:function(){i=!0,n(!0)},off:function(){i=!1}}}),React.mixins.add("events",function(){function t(e,t){return function(){e.apply(t,arguments)}}var n=[{triggerWith:function(){var e=Array.prototype.slice.call(arguments),t=this;return function(){t.trigger.apply(this,e)}},getInitialState:function(){var t=this._eventHandlers=[];if(this.events){var n;for(var i in this.events)n=e(i,this.events[i],this),n.initialize&&n.initialize.call(this),t.push(n)}return null},componentDidUpdate:function(){for(var e,t=this._eventHandlers,n=0;n<t.length;n++)e=t[n],e.isStale&&e.isStale.call(this)&&(e.off.call(this),e.on.call(this))},componentDidMount:function(){for(var e=this._eventHandlers,t=0;t<e.length;t++)e[t].on.call(this)},componentWillUnmount:function(){for(var e=this._eventHandlers,t=0;t<e.length;t++)e[t].off.call(this)}}];if(s.mixin){var i={},a={};for(var r in s.mixin)i[r]=t(s.mixin[r],a);i.getInitialState=function(){return{__events:a}},n.push(i)}return n})}(),function(){function e(e){return e?_.isArray(e)?e:[e]:void 0}function t(e){return e.props.key||e.props.ref}function n(t,n,i,a){var r,o,s=Array.isArray(t)?t:e(n.props[t]);if(s){for(var c=0;c<s.length;c++)r=s[c],o=i.replace("{key}",r),n.modelOn(o,_.bind(a,n),this);return s}}function i(e,t){var n,i=this;if(t=_.extend({type:e},t),this.state?(n=this.state.__modelEvents,i=this.state):n=this.__modelEvents,n||(n=i.__modelEvents=[]),t.context=t.context||this,n.push(t),this.isMounted()){var a=t.model||this.getModel();a&&a[t.type](t.event,t.callback,t.context)}}function a(e){for(var t,n=0;n<e.length;n++)t=e[n],"true"===t?t=!0:"false"===t?t=!1:t.match(/^[0-9]+$/)?t=parseInt(t):t.match(/^[0-9]+\.[0-9]+/)&&(t=parseFloat(t)),e[n]=t;return e}if(React.mixins.add("modelAware",{getModel:function(){return this.props.model},setModel:function(e){this._modelUnbindAll&&this._modelUnbindAll(!0),this.setProps({model:e}),this._modelBindAll&&this.isMounted()&&this._modelBindAll()}}),React.mixins.add("modelValueAware",function(e){return{getModelValue:function(){e=e||t(this);var n=this.getModel();return n&&e?n.get(e):void 0},setModelValue:function(n,i){e=e||t(this);var a=this.getModel();return a=this.getModel(),a&&e?a.set(e,n,i):void 0}}},"modelAware"),React.mixins.add("modelPopulate",{modelPopulate:function(e,n,i){_.isFunction(e)&&(i=n,n=e,e=void 0);var a={};if(e||(e=_.map(this.refs,function(e){return e})),_.each(e,function(e){if(e.getUIModelValue){var n=t(e),i=e.getUIModelValue();a[n]=i}}),n&&this.getModel){var r=this.getModel();r&&r.set(a,i||{validate:!0})&&n.call(this,r)}return a}},"modelAware"),React.mixins.add("modelValidator",{modelValidate:function(e,t){var n=this.getModel();return n&&n.validate?this.modelIndexErrors(n.validate(e,t))||!1:void 0}},"modelAware","modelIndexErrors"),React.mixins.add("modelEventAware",{getInitialState:function(){return{}},modelOn:function(e,t){var n=t?{event:e,callback:t}:e;i.call(this,"on",n)},modelOnce:function(e,t){var n=t?{event:e,callback:t}:e;i.call(this,"once",n)},modelOff:function(e,t){var n=t?{event:e,callback:t}:e,i=this.state.__modelEvents;if(i)for(var a,r=0;r<i.length;r++)if(a=i[r],a.event===n.event&&a.model===n.model&&a.callback===n.callback){var o=n.model||this.getModel();o&&o.off(n.event,n.callback,n.context||this),i.splice(r,1)}},_modelBindAll:function(){if(this.state){var e=this.__modelEvents;if(e&&(delete this.__modelEvents,this.state.__modelEvents=e),e=this.state.__modelEvents){var t=this.getModel();_.each(e,function(e){var n=e.model||t;n&&n[e.type](e.event,e.callback,e.context)})}}},_modelUnbindAll:function(e){if(this.state){var t=this.state.__modelEvents,n=this.getModel();t&&(_.each(t,function(e){var t=e.model||n;t&&t.off(e.event,e.callback,e.context)}),e||(this.state.__modelEvents=[]))}},componentDidMount:function(){this._modelUnbindAll(!0),this._modelBindAll(!0)},componentWillUnmount:function(){this._modelUnbindAll(!0)}},"modelAware"),React.mixins.add("modelChangeAware",{getInitialState:function(){return _.each(["change","reset","add","remove","sort"],function(e){this.modelOn(e,function(){this.deferUpdate()})},this),null}},"modelEventAware","deferUpdate"),React.mixins.add("modelAsyncAware",{getInitialState:function(){this.modelOn("async",function(e,t){this.setState({loading:!0});var n=this.getModel();t.on("success",function(){this.isMounted()&&this.setState({loading:!!n.isLoading()})},this),t.on("error",function(e){this.isMounted()&&this.setState({loading:!!n.isLoading(),error:e})},this)});var e=this.getModel();return e&&e.isLoading()?{loading:!0}:{}},componentDidMount:function(){var e=this.state,t=this.getModel();t&&(t.isLoading()?(this.modelOnce("async:load-complete",function(){this.setState({loading:!1})}),e.loading||this.setState({loading:!0})):e.loading&&this.setState({loading:!1}))}},"modelEventAware"),React.mixins.add("modelInvalidAware",{getInitialState:function(){var e=t(this);return e&&this.modelOn("invalid",function(t,n){n=this.modelIndexErrors(n)||{};var i=n[e];i&&this.setState({error:i})}),{}}},"modelIndexErrors","modelEventAware"),React.mixins.add("modelIndexErrors",{modelIndexErrors:function(e){if(Array.isArray(e)){var t={};return _.each(e,function(e){for(var n in e)t[n]=e[n]}),t}return e}}),React.mixins.add("modelLoadOn",function(){var e=arguments.length>0?Array.prototype.slice.call(arguments,0):void 0;return{getInitialState:function(){e=n(e||"loadOn",this,"async:{key}",function(e){this.setState({loading:!0}),e.on("complete",function(){this.isMounted()&&this.setState({loading:!1})},this)});var t=this.getModel();if(t){var i,a=t.isLoading();if(a)for(var r=function(){this.isMounted()&&this.setState({loading:!1})},o=0;o<a.length;o++){var s=e.indexOf(a[o].method);if(s>=0)return i=e[s],a[o].on("complete",r,this),{loading:!0}}}return{}},loadWhile:function(e){function t(t){var i=e[t];e[t]=function(){n.setState({loading:!1}),i&&i.apply(this,arguments)}}e=e||{};var n=this;return t("error"),t("success"),this.setState({loading:!0}),e}}},"modelEventAware"),React.mixins.add("modelUpdateOn",function(){var e=arguments.length>0?Array.prototype.slice.call(arguments,0):void 0;return{getInitialState:function(){n(e||"updateOn",this,"{key}",function(){this.deferUpdate()})}}},"modelEventAware","deferUpdate"),React.events){React.events.mixin=React.events.mixin||Backbone.Events;var r=/^model(\[.+\])?$/;React.events.handle(r,function(e,t){var n=e.key.match(r),i=n[1]&&n[1].substring(1,n[1].length-1),a=i&&(this.props[i]||this.refs[i]);if(!a&&i)throw new Error('no model found with "'+i+'"');var o={model:a,event:e.path,callback:t};return{on:function(){this.modelOn(o)},off:function(){}}});var o=React.events.specials;if(o){var s=["memoize","delay","defer","throttle","debounce","once"];_.each(s,function(e){o[e]=o[e]||function(t,n){return n=a(n),n.splice(0,0,t),_[e].apply(_,n)}})}}var c=function(e,t,n,i){return React.createClass(_.extend({mixins:["modelValueAware"],render:function(){var i={},a=this.getModelValue();return n?i.defaultChecked=a:i.defaultValue=a,React.DOM[e](_.extend(i,t,this.props),this.props.children)},getUIModelValue:function(){if(this.isMounted()){if(!n)return $(this.getDOMNode()).val();var e=this.getDOMNode();if(e.checked)return e.value||!0}}},i))};Backbone.input=Backbone.input||{},_.defaults(Backbone.input,{Text:c("input",{type:"text"}),TextArea:c("textarea"),Select:c("select",void 0,void 0),CheckBox:c("input",{type:"checkbox"},!0),RadioGroup:React.createClass({mixins:["modelValueAware"],render:function(){var e=this.props;return React.DOM[e.tag||"span"](e,e.children)},componentDidMount:function(){var e=this.getModelValue();if(e){var t='input[value="'+e.replace('"','\\"')+'"]',n=$(this.getDOMNode()).find(t);n.attr("checked","checked")}},getUIModelValue:function(){if(this.isMounted())for(var e='input[type="radio"]',t=$(this.getDOMNode()).find(e),n=0;n<t.length;n++)if(t[n].checked)return t[n].value}})})}()});